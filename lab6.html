<!DOCTYPE html>
<html lang="ru">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>–ë—É–∫–≤–∞ "–ë"</title>
    <script src="https://cdn.plot.ly/plotly-2.27.0.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/mathjs/12.2.1/math.js"></script>

    <style>
        :root {
            --bg-main: #121212;
            --bg-panel: #1E1E1E;
            --text-main: #E0E0E0;
            --accent: #4A9CFF;
            --accent-dim: #357ABD;
            --range-track: #2A2A2A;
            --vertex-3d: #FF6B8B;
        }

        body {
            font-family: 'Segoe UI', Roboto, 'Helvetica Neue', sans-serif;
            background-color: var(--bg-main);
            color: var(--text-main);
            margin: 0;
            height: 100vh;
            overflow: hidden;
        }

        .container {
            display: flex;
            width: 100%;
            height: 100%;
        }

        .plot-area {
            flex: 1;
            background-color: var(--bg-main);
            position: relative;
        }

        .control-panel {
            width: 380px;
            background-color: var(--bg-panel);
            padding: 20px;
            overflow-y: auto;
            border-left: 1px solid #333;
            box-shadow: -5px 0 15px rgba(0,0,0,0.3);
            display: flex;
            flex-direction: column;
            gap: 20px;
        }

        h3 {
            color: var(--accent);
            text-align: center;
            border-bottom: 2px solid var(--accent-dim);
            padding-bottom: 10px;
            margin-top: 0;
            font-weight: 500;
        }

        .control-group {
            background: rgba(255, 255, 255, 0.05);
            padding: 15px;
            border-radius: 10px;
            border: 1px solid rgba(255, 255, 255, 0.1);
            backdrop-filter: blur(5px);
        }

        .label-row {
            display: flex;
            justify-content: space-between;
            margin-bottom: 8px;
            font-size: 0.9rem;
            font-weight: 500;
            color: #CCCCCC;
        }

        .val-display {
            color: var(--accent);
            font-family: 'Consolas', 'Monaco', monospace;
            background: rgba(0, 0, 0, 0.2);
            padding: 2px 8px;
            border-radius: 4px;
            border: 1px solid rgba(74, 156, 255, 0.3);
        }

        input[type=range] {
            -webkit-appearance: none; 
            width: 100%; 
            background: transparent; 
            height: 24px;
        }

        input[type=range]::-webkit-slider-thumb {
            -webkit-appearance: none;
            height: 18px;
            width: 18px;
            border-radius: 50%;
            background: var(--accent);
            cursor: pointer;
            margin-top: -7px; 
            border: 2px solid white;
            box-shadow: 0 2px 6px rgba(0,0,0,0.3);
            transition: all 0.2s ease;
        }

        input[type=range]::-webkit-slider-thumb:hover {
            background: #5DA8FF;
            transform: scale(1.1);
        }

        input[type=range]::-webkit-slider-runnable-track {
            width: 100%;
            height: 4px;
            cursor: pointer;
            background: var(--range-track);
            border-radius: 2px;
            border: none;
        }

        button {
            width: 100%;
            padding: 12px;
            background: linear-gradient(to bottom, #2A3A50, #1E2A3A);
            color: #FFFFFF;
            border: 1px solid rgba(74, 156, 255, 0.3);
            border-radius: 8px;
            font-weight: 500;
            cursor: pointer;
            text-transform: none;
            letter-spacing: 0.5px;
            transition: all 0.3s ease;
            box-shadow: 0 2px 8px rgba(0,0,0,0.2);
        }

        button:hover {
            background: linear-gradient(to bottom, #3A4A60, #2A3A50);
            border-color: var(--accent);
            transform: translateY(-1px);
            box-shadow: 0 4px 12px rgba(74, 156, 255, 0.2);
        }

        .btn-reset {
            background: linear-gradient(to bottom, #3A1A25, #2A0A15);
            border-color: rgba(255, 107, 139, 0.3);
        }
        .btn-reset:hover {
            background: linear-gradient(to bottom, #4A2A35, #3A1A25);
            border-color: var(--vertex-3d);
        }

        .matrix-container {
    background: rgba(0, 0, 0, 0.3);
    border: 1px solid rgba(100, 255, 100, 0.2);
    border-radius: 8px;
    padding: 12px;
    margin-top: 10px;

    flex: 1;
    overflow-y: auto;
    min-height: 250px;
}


        .matrix-title {
            font-size: 12px;
            color: #666;
            margin-bottom: 8px;
        }

        .matrix-table {
            border-collapse: collapse;
            width: 100%;
            font-family: 'Consolas', 'Monaco', monospace;
            font-size: 13px;
        }

        .matrix-table td {
            border: 1px solid rgba(255, 255, 255, 0.1);
            padding: 6px 10px;
            text-align: center;
            color: #90EE90;
            min-width: 60px;
        }

        .matrix-table tr:first-child td {
            border-top: 2px solid rgba(100, 255, 100, 0.4);
        }

        .matrix-table tr:last-child td {
            border-bottom: 2px solid rgba(100, 255, 100, 0.4);
        }

        .matrix-table td:first-child {
            border-left: 2px solid rgba(100, 255, 100, 0.4);
        }

        .matrix-table td:last-child {
            border-right: 2px solid rgba(100, 255, 100, 0.4);
        }

        .modal {
            display: none;
            position: fixed;
            z-index: 1000;
            left: 0; top: 0;
            width: 100%; height: 100%;
            background-color: rgba(0,0,0,0.85);
            justify-content: center;
            align-items: center;
            backdrop-filter: blur(3px);
        }
        .modal-content {
            background: var(--bg-panel);
            border: 1px solid rgba(74, 156, 255, 0.4);
            width: 90%; height: 90%;
            display: flex; flex-direction: column;
            padding: 20px;
            border-radius: 12px;
            box-shadow: 0 10px 30px rgba(0,0,0,0.5);
        }
        .proj-grid {
            display: flex; flex: 1; gap: 15px;
            margin-top: 15px;
        }
        .proj-item { 
            flex: 1; 
            border: 1px solid rgba(255, 255, 255, 0.1);
            border-radius: 8px;
            overflow: hidden;
            background: rgba(0, 0, 0, 0.2);
        }

        .control-panel::-webkit-scrollbar {
            width: 6px;
        }
        .control-panel::-webkit-scrollbar-track {
            background: rgba(0,0,0,0.1);
        }
        .control-panel::-webkit-scrollbar-thumb {
            background: var(--accent-dim);
            border-radius: 3px;
        }
        
        .info-box {
            background: rgba(0, 0, 0, 0.2);
            padding: 10px;
            border-radius: 6px;
            border-left: 3px solid var(--accent);
            font-size: 12px;
            color: #AAA;
            margin-top: 5px;
        }
    </style>
</head>
<body>

<div class="container">
    <div id="plot3d" class="plot-area"></div>

    <div class="control-panel">
        <h3>–õ–∞–± 6: –ë—É–∫–≤–∞ "–ë" (3D –ø—Ä–µ–æ–±—Ä–∞–∑–æ–≤–∞–Ω–∏—è)</h3>

        <div class="control-group">
            <div class="label-row">
                <span>–í—Ä–∞—â–µ–Ω–∏–µ X</span>
                <span id="val-rx" class="val-display">0¬∞</span>
            </div>
            <input type="range" id="rx" min="0" max="360" value="0" oninput="updateAll()">
            
            <div class="label-row" style="margin-top:10px;">
                <span>–í—Ä–∞—â–µ–Ω–∏–µ Y</span>
                <span id="val-ry" class="val-display">0¬∞</span>
            </div>
            <input type="range" id="ry" min="0" max="360" value="20" oninput="updateAll()">

            <div class="label-row" style="margin-top:10px;">
                <span>–í—Ä–∞—â–µ–Ω–∏–µ Z</span>
                <span id="val-rz" class="val-display">0¬∞</span>
            </div>
            <input type="range" id="rz" min="0" max="360" value="0" oninput="updateAll()">
        </div>

        <div class="control-group">
            <div class="label-row">
                <span>–ú–∞—Å—à—Ç–∞–±</span>
                <span id="val-s" class="val-display">1.0</span>
            </div>
            <input type="range" id="s" min="0.1" max="3.0" step="0.1" value="1.0" oninput="updateAll()">
        </div>

        <div class="control-group">
            <div class="label-row"><span>–°–¥–≤–∏–≥ X</span> <span id="val-tx" class="val-display">0</span></div>
            <input type="range" id="tx" min="-10" max="10" step="0.5" value="0" oninput="updateAll()">

            <div class="label-row" style="margin-top:5px;"><span>–°–¥–≤–∏–≥ Y</span> <span id="val-ty" class="val-display">0</span></div>
            <input type="range" id="ty" min="-10" max="10" step="0.5" value="0" oninput="updateAll()">

            <div class="label-row" style="margin-top:5px;"><span>–°–¥–≤–∏–≥ Z</span> <span id="val-tz" class="val-display">0</span></div>
            <input type="range" id="tz" min="-10" max="10" step="0.5" value="0" oninput="updateAll()">
        </div>

        <button onclick="showProjections()">üìä –û—Ä—Ç–æ–≥—Ä–∞—Ñ–∏—á–µ—Å–∫–∏–µ –ø—Ä–æ–µ–∫—Ü–∏–∏</button>
        <button class="btn-reset" onclick="resetAll()">‚ôª –°–±—Ä–æ—Å –≤—Å–µ—Ö –ø–∞—Ä–∞–º–µ—Ç—Ä–æ–≤</button>

        <div class="matrix-container">
            <div class="matrix-title">–ò—Ç–æ–≥–æ–≤–∞—è –º–∞—Ç—Ä–∏—Ü–∞ –ø—Ä–µ–æ–±—Ä–∞–∑–æ–≤–∞–Ω–∏—è (4√ó4):</div>
            <div id="matrixOutput"></div>
        </div>
        
    </div>
</div>

<div id="projModal" class="modal">
    <div class="modal-content">
        <div style="display:flex; justify-content:space-between;">
            <h2 style="color:var(--accent); margin:0;">–û—Ä—Ç–æ–≥—Ä–∞—Ñ–∏—á–µ—Å–∫–∏–µ –ø—Ä–æ–µ–∫—Ü–∏–∏</h2>
            <button onclick="document.getElementById('projModal').style.display='none'" style="width:auto; padding:5px 20px; background:var(--vertex-3d); border:none;">‚úñ</button>
        </div>
        <div class="proj-grid">
            <div id="pXY" class="proj-item"></div>
            <div id="pXZ" class="proj-item"></div>
            <div id="pYZ" class="proj-item"></div>
        </div>
    </div>
</div>

<script>
    const rotationCache = {
        rx: { angle: null, rad: null, matrix: null },
        ry: { angle: null, rad: null, matrix: null },
        rz: { angle: null, rad: null, matrix: null }
    };

    let cachedTransformedVertices = null;
    let cachedMatrix = math.identity(4);

    const initialVertices = [
        [0, 0, 0.5],    [3.5, 0, 0.5],  [3.5, 3, 0.5],  [1, 3, 0.5],
        [1, 4, 0.5],    [3.5, 4, 0.5],  [3.5, 5, 0.5],  [0, 5, 0.5],
        [1, 0.8, 0.5],  [2.5, 0.8, 0.5],[2.5, 2.2, 0.5],[1, 2.2, 0.5],
        [0, 0, -0.5],   [3.5, 0, -0.5], [3.5, 3, -0.5], [1, 3, -0.5],
        [1, 4, -0.5],   [3.5, 4, -0.5], [3.5, 5, -0.5], [0, 5, -0.5],
        [1, 0.8, -0.5], [2.5, 0.8, -0.5],[2.5, 2.2, -0.5],[1, 2.2, -0.5]
    ];

    initialVertices.forEach(v => { 
        v[0] -= 1.75; 
        v[1] -= 2.5; 
    });

    const edges = [
        [0,1],[1,2],[2,3],[3,4],[4,5],[5,6],[6,7],[7,0],
        [8,9],[9,10],[10,11],[11,8],
        [12,13],[13,14],[14,15],[15,16],[16,17],[17,18],[18,19],[19,12],
        [20,21],[21,22],[22,23],[23,20],
        [0,12],[1,13],[2,14],[3,15],[4,16],[5,17],[6,18],[7,19],
        [8,20],[9,21],[10,22],[11,23]
    ];

    function getRotationMatrix(axis, angleDeg) {
        const cache = rotationCache[axis];
        if (cache.angle === angleDeg) {
            return cache.matrix;
        }
        
        const rad = angleDeg * Math.PI / 180;
        let matrix;
        
        if (axis === 'rx') {
            matrix = [
                [1, 0, 0, 0],
                [0, Math.cos(rad), -Math.sin(rad), 0],
                [0, Math.sin(rad), Math.cos(rad), 0],
                [0, 0, 0, 1]
            ];
        } else if (axis === 'ry') {
            matrix = [
                [Math.cos(rad), 0, Math.sin(rad), 0],
                [0, 1, 0, 0],
                [-Math.sin(rad), 0, Math.cos(rad), 0],
                [0, 0, 0, 1]
            ];
        } else if (axis === 'rz') {
            matrix = [
                [Math.cos(rad), -Math.sin(rad), 0, 0],
                [Math.sin(rad), Math.cos(rad), 0, 0],
                [0, 0, 1, 0],
                [0, 0, 0, 1]
            ];
        }
        
        cache.angle = angleDeg;
        cache.rad = rad;
        cache.matrix = matrix;
        
        return matrix;
    }

    function transformVertices(matrix) {
        if (math.deepEqual(matrix, cachedMatrix) && cachedTransformedVertices) {
            return cachedTransformedVertices;
        }
        
        const transformed = initialVertices.map(v => {
            const col = [v[0], v[1], v[2], 1];
            const res = math.multiply(matrix, col);
            return [res[0], res[1], res[2]];
        });
        
        cachedMatrix = math.clone(matrix);
        cachedTransformedVertices = transformed;
        
        return transformed;
    }

    function createStaticAxes() {
        const axisLength = 6;
        const axisPoints = {
            x: [[-axisLength, 0, 0], [axisLength, 0, 0]],
            y: [[0, -axisLength, 0], [0, axisLength, 0]],
            z: [[0, 0, -axisLength], [0, 0, axisLength]]
        };
        
        let axesTraces = [];
        
        axesTraces.push({
            type: 'scatter3d',
            mode: 'lines',
            x: [axisPoints.x[0][0], axisPoints.x[1][0]],
            y: [axisPoints.x[0][1], axisPoints.x[1][1]],
            z: [axisPoints.x[0][2], axisPoints.x[1][2]],
            line: { width: 4, color: '#FF4444' },
            showlegend: false,
            hoverinfo: 'none'
        });
        
        axesTraces.push({
            type: 'scatter3d',
            mode: 'lines',
            x: [axisPoints.y[0][0], axisPoints.y[1][0]],
            y: [axisPoints.y[0][1], axisPoints.y[1][1]],
            z: [axisPoints.y[0][2], axisPoints.y[1][2]],
            line: { width: 4, color: '#44FF44' },
            showlegend: false,
            hoverinfo: 'none'
        });
        
        axesTraces.push({
            type: 'scatter3d',
            mode: 'lines',
            x: [axisPoints.z[0][0], axisPoints.z[1][0]],
            y: [axisPoints.z[0][1], axisPoints.z[1][1]],
            z: [axisPoints.z[0][2], axisPoints.z[1][2]],
            line: { width: 4, color: '#4444FF' },
            showlegend: false,
            hoverinfo: 'none'
        });
        
        axesTraces.push({
            type: 'scatter3d',
            mode: 'text',
            x: [axisLength+0.5, 0, 0],
            y: [0, axisLength+0.5, 0],
            z: [0, 0, axisLength+0.5],
            text: ['X', 'Y', 'Z'],
            textfont: { size: 14, color: '#FFFFFF' },
            showlegend: false,
            hoverinfo: 'none'
        });
        
        return axesTraces;
    }

    function displayMatrixAsTable(matrix) {
        let html = '<table class="matrix-table">';
        
        matrix.forEach(row => {
            html += '<tr>';
            row.forEach(val => {
                const formatted = Math.abs(val) < 0.0001 ? '0' : val.toFixed(3);
                html += `<td>${formatted}</td>`;
            });
            html += '</tr>';
        });
        
        html += '</table>';
        return html;
    }

    let lastValues = {};
    function updateAll() {
        const rx = +document.getElementById('rx').value;
        const ry = +document.getElementById('ry').value;
        const rz = +document.getElementById('rz').value;
        const s  = +document.getElementById('s').value;
        const tx = +document.getElementById('tx').value;
        const ty = +document.getElementById('ty').value;
        const tz = +document.getElementById('tz').value;

        const currentValues = { rx, ry, rz, s, tx, ty, tz };
        const valuesChanged = !isEqual(currentValues, lastValues);
        
        if (!valuesChanged) {
            return;
        }
        
        lastValues = currentValues;

        document.getElementById('val-rx').innerText = rx + "¬∞";
        document.getElementById('val-ry').innerText = ry + "¬∞";
        document.getElementById('val-rz').innerText = rz + "¬∞";
        document.getElementById('val-s').innerText  = s.toFixed(1);
        document.getElementById('val-tx').innerText = tx;
        document.getElementById('val-ty').innerText = ty;
        document.getElementById('val-tz').innerText = tz;

        const S = [
            [s, 0, 0, 0],
            [0, s, 0, 0],
            [0, 0, s, 0],
            [0, 0, 0, 1]
        ];

        const RX = getRotationMatrix('rx', rx);
        const RY = getRotationMatrix('ry', ry);
        const RZ = getRotationMatrix('rz', rz);

        const T = [
            [1, 0, 0, tx],
            [0, 1, 0, ty],
            [0, 0, 1, tz],
            [0, 0, 0, 1]
        ];

        let M = math.multiply(RX, S);
        M = math.multiply(RY, M);
        M = math.multiply(RZ, M);
        M = math.multiply(T, M);
        
        document.getElementById('matrixOutput').innerHTML = displayMatrixAsTable(M);

        drawScene(M);
    }

    function isEqual(obj1, obj2) {
        if (!obj2) return false;
        return obj1.rx === obj2.rx &&
               obj1.ry === obj2.ry &&
               obj1.rz === obj2.rz &&
               obj1.s === obj2.s &&
               obj1.tx === obj2.tx &&
               obj1.ty === obj2.ty &&
               obj1.tz === obj2.tz;
    }

    function drawScene(matrix) {
        const transformed = transformVertices(matrix);

        let x = [], y = [], z = [];
        edges.forEach(e => {
            const p1 = transformed[e[0]];
            const p2 = transformed[e[1]];
            x.push(p1[0], p2[0], null);
            y.push(p1[1], p2[1], null);
            z.push(p1[2], p2[2], null);
        });

        let vx = transformed.map(v => v[0]);
        let vy = transformed.map(v => v[1]);
        let vz = transformed.map(v => v[2]);

        const traceLines = {
            type: 'scatter3d',
            mode: 'lines',
            x: x, y: y, z: z,
            line: { width: 4, color: '#4A9CFF' },
            hoverinfo: 'none',
            name: '–ë—É–∫–≤–∞ "–ë"'
        };

        const traceMarkers = {
            type: 'scatter3d',
            mode: 'markers',
            x: vx, y: vy, z: vz,
            marker: { size: 5, color: '#FF6B8B' },
            hoverinfo: 'text',
            text: vx.map((_, i) => `V${i}`),
            name: '–í–µ—Ä—à–∏–Ω—ã'
        };

        const axesTraces = createStaticAxes();

        const allTraces = [...axesTraces, traceLines, traceMarkers];

        const layout = {
            paper_bgcolor: '#121212',
            plot_bgcolor: '#121212',
            showlegend: true,
            legend: {
                x: 0.02,
                y: 0.98,
                bgcolor: 'rgba(30, 30, 30, 0.8)',
                font: {color: '#E0E0E0'}
            },
            margin: {l:0, r:0, t:20, b:0},
            scene: {
                aspectmode: 'data',
                xaxis: { 
                    title: 'X', 
                    color: '#FF4444', 
                    backgroundcolor: '#121212', 
                    gridcolor: '#2A2A2A',
                    range: [-8, 8]
                },
                yaxis: { 
                    title: 'Y', 
                    color: '#44FF44', 
                    backgroundcolor: '#121212', 
                    gridcolor: '#2A2A2A',
                    range: [-8, 8]
                },
                zaxis: { 
                    title: 'Z', 
                    color: '#4444FF', 
                    backgroundcolor: '#121212', 
                    gridcolor: '#2A2A2A',
                    range: [-8, 8]
                },
                camera: { 
                    eye: {x:1.8, y:1.8, z:1.8},
                    up: {x:0, y:0, z:1}
                }
            }
        };

        Plotly.react('plot3d', allTraces, layout);
        return transformed;
    }

    function resetAll() {
        document.getElementById('rx').value = 0;
        document.getElementById('ry').value = 20;
        document.getElementById('rz').value = 0;
        document.getElementById('s').value = 1;
        document.getElementById('tx').value = 0;
        document.getElementById('ty').value = 0;
        document.getElementById('tz').value = 0;
        
        rotationCache.rx.angle = null;
        rotationCache.ry.angle = null;
        rotationCache.rz.angle = null;
        cachedTransformedVertices = null;
        
        updateAll();
    }

    function showProjections() {
        const modal = document.getElementById('projModal');
        modal.style.display = 'flex';
        
        const verts = transformVertices(cachedMatrix);
        
        const style2d = (title, ax1, ax2) => ({
            title: { text: title, font: {color: '#4A9CFF', size: 14} },
            paper_bgcolor: '#1E1E1E',
            plot_bgcolor: '#121212',
            margin: {l:40, r:10, t:40, b:40},
            xaxis: {
                title: ax1, 
                color: '#AAA', 
                gridcolor: '#2A2A2A',
                zeroline: true,
                zerolinecolor: '#444',
                range: [-8, 8]
            },
            yaxis: {
                title: ax2, 
                color: '#AAA', 
                gridcolor: '#2A2A2A',
                zeroline: true,
                zerolinecolor: '#444',
                range: [-8, 8],
                scaleanchor: "x", 
                scaleratio: 1
            }
        });

        const plot2D = (divId, idx1, idx2, title, label1, label2) => {
            let px = [], py = [];
            edges.forEach(e => {
                px.push(verts[e[0]][idx1], verts[e[1]][idx1], null);
                py.push(verts[e[0]][idx2], verts[e[1]][idx2], null);
            });
            
            const axisLength = 6;
            px.push(-axisLength, axisLength, null, 0, 0, null);
            py.push(0, 0, null, -axisLength, axisLength, null);
            
            Plotly.newPlot(divId, [{
                type: 'scatter',
                mode: 'lines',
                x: px,
                y: py,
                line: {color: '#4A9CFF', width: 2}
            }, {
                type: 'scatter',
                mode: 'lines',
                x: [-axisLength, axisLength],
                y: [0, 0],
                line: {color: '#FF4444', width: 2},
                showlegend: false
            }, {
                type: 'scatter',
                mode: 'lines',
                x: [0, 0],
                y: [-axisLength, axisLength],
                line: {color: '#44FF44', width: 2},
                showlegend: false
            }], style2d(title, label1, label2));
        };

        plot2D('pXY', 0, 1, '–ü—Ä–æ–µ–∫—Ü–∏—è XY (–Ω–∞ –ø–ª–æ—Å–∫–æ—Å—Ç—å Oxy)', 'X', 'Y');
        plot2D('pXZ', 0, 2, '–ü—Ä–æ–µ–∫—Ü–∏—è XZ (–Ω–∞ –ø–ª–æ—Å–∫–æ—Å—Ç—å Oxz)', 'X', 'Z');
        plot2D('pYZ', 1, 2, '–ü—Ä–æ–µ–∫—Ü–∏—è YZ (–Ω–∞ –ø–ª–æ—Å–∫–æ—Å—Ç—å Oyz)', 'Y', 'Z');
    }

    updateAll();
    
    window.onresize = () => {
        Plotly.Plots.resize('plot3d');
    };
</script>
</body>
</html>